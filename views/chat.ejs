<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="\main.css">
</head>
<body class="grey-bg">
    <%- include('nav.ejs') %>
    <div class="container p-4 detail">
        <div class="row">
          <div class="col-3">
            <ul class="list-group chat-list">
                <% for (let i = 0; i < data.length; i++ ){%>
                    <li class="list-group-item" data-id="<%= data[i]._id %>" data-i="<%= i %>" 
                      data-cnt=0>
                        <h6><%= data[i].title %></h6>
                        <button class="dele" data-id="<%= data[i]._id %>">ğŸ—‘ï¸</button>
                    </li>
                <%}%>
             </ul>
           </div>
      
           <div class="col-9 p-0">
             <div class="chat-room">
                <ul class="list-group chat-content">
                  <div class="infomation">
                    <p style="font-weight: bold;">â›”ì‚¬ìš©ë°©ë²•â›”<br>
                      1. ì™¼ìª½ì„ íƒì°½ì—ì„œ ì±„íŒ…ë°© ì„ íƒ í›„ ì±„íŒ… ì‹œì‘<br>
                      2. ì±„íŒ…ë°© ì‚­ì œ : ì“°ë ˆê¸°í†µ ì•„ì´ì½˜ ëˆ„ë¥¸ í›„ ìƒˆë¡œê³ ì¹¨<br>
                      3. ê¸€ì“´ì´ê°€ ê¸€ ì‚­ì œí•˜ë©´ ì±„íŒ…ë°©ë„ ì‚¬ë¼ì§<br>
                    </p>
                  </div>
                </ul>
              <div class="input-group">
                <input class="form-control" id="chat-input">
                <button class="btn btn-secondary" id="send">ì „ì†¡</button>
              </div>
            </div>
          </div>
        </div>
    </div> 


    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        var ì§€ê¸ˆëˆ„ë¥¸ì±„íŒ…ë°©id
        var ì±„íŒ…ë°©ì‚­ì œid
        var eventSource;
        var cnt;
        $('.list-group-item').click(function(e){
          ì§€ê¸ˆëˆ„ë¥¸ì±„íŒ…ë°©id = this.dataset.id;
          $('.chat-content').html('');
          if(eventSource != undefined){
            eventSource.close()
          }
          var í˜„ì¬ì‚¬ëŒ = '<%= cur %>';
          eventSource = new EventSource('/message/' + ì§€ê¸ˆëˆ„ë¥¸ì±„íŒ…ë°©id);
          eventSource.addEventListener('test', function(e){
            var ê°€ì ¸ì˜¨ê±° = JSON.parse(e.data);
            ê°€ì ¸ì˜¨ê±°.forEach(function(i){
              if(i.userid==í˜„ì¬ì‚¬ëŒ){
                $('.chat-content').append('<li><span class="chat-box mine">'+i.content+'</span></li>')
                $('.chat-content').append('<li><span class="mine time-box">'+i.date+'</span></li>')
              } 
              else {
                $('.chat-content').append('<li><span class="chat-box">'+i.content+'</span></li>')
                $('.chat-content').append('<li><span class="time-box">'+i.date+'</span></li>')
              }
            })
            var ì‹¤ì œë†’ì´ = document.querySelector('.chat-content').scrollHeight;
            $('.chat-content').scrollTop(ì‹¤ì œë†’ì´+100); // ì—¬ê¸°ì„œ ìŠ¤í¬ë¡¤ë§¨ë°‘ìœ¼ë¡œ (ë°ì´í„°ë¥¼ ìˆ˜ì‹ í–ˆì„ë•Œ)
          })
          if(this.dataset.cnt.length%2==1){
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.backgroundColor ="#5F5F5F";
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.border ='none';
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.color ='white';
            this.dataset.cnt+=1;
          }   
          else{
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.backgroundColor ="white";
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.border ='1px solid rgba(0,0,0,.125)';
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.color ='#212529';
            document.querySelectorAll('.list-group-item')[this.dataset.i].style.padding ='.5rem 1rem';
            this.dataset.cnt+=1;
          }
        })
        $('#send').click(function(){
            var ì±„íŒ…ë‚´ìš© = $('#chat-input').val();
            var ë³´ë‚¼ê±° = {
                parent : ì§€ê¸ˆëˆ„ë¥¸ì±„íŒ…ë°©id,
                content : ì±„íŒ…ë‚´ìš©,
            }
            $.post('/message', ë³´ë‚¼ê±°).then(()=> {
            })
            $('#chat-input').val('');
        })
        $('.input-group').keypress(function(e){
          if (e.keyCode===13){
            var ì±„íŒ…ë‚´ìš© = $('#chat-input').val();
            var ë³´ë‚¼ê±° = {
                parent : ì§€ê¸ˆëˆ„ë¥¸ì±„íŒ…ë°©id,
                content : ì±„íŒ…ë‚´ìš©,
            }
            $.post('/message', ë³´ë‚¼ê±°).then(()=> {
            })
            $('#chat-input').val(''); 
          } 
        })

        $('.dele').click(function(e){
          ì±„íŒ…ë°©ì‚­ì œid = this.dataset.id  
          var ë³´ë‚¼ê±° = {ì‚­ì œid : ì±„íŒ…ë°©ì‚­ì œid};
          $.post('/deletee', ë³´ë‚¼ê±°).then(()=> {
          })
        })


    </script>
</body>
</html>