<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¹ë®¤ë‹ˆí‹°</title>
    <meta name="description" content="ê²Œì‹œë¬¼ ëª©ë¡ í˜ì´ì§€ì…ë‹ˆë‹¤. ì—…ë¡œë“œëœ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ê³ , 
    ê²€ìƒ‰í•˜ê³ , ìƒˆë¡œìš´ ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="\main.css">
</head>
<body class="fix" style="position: relative;">
    <%- include('nav.ejs', { isRead: isRead }) %>
    <div class="section2">
        <div class="section2-1"></div>
        <%for (let i=0; i<ê¸€ëª©ë¡.length; i++){ %>
            <% k = 0 %>
            <div class="white-bg">
                <div class="list-box">
                <a href="/detail/<%= ê¸€ëª©ë¡[i]._id %>" aria-label="ê²Œì‹œë¬¼ ì„¸ë¶€ì‚¬í•­ í˜ì´ì§€ë¡œ ì´ë™">
                    <img class="list-left" src='/image/dinosaur.webp' onerror="this.src='/image/dinosaur.webp'" 
                    alt="ì¸ë„¤ì¼" loading="lazy" />
                </a>
                    <h4 class="list-right">
                        <a href="/detail/<%= ê¸€ëª©ë¡[i]._id %>" aria-label="ê²Œì‹œë¬¼ ì„¸ë¶€ì‚¬í•­ í˜ì´ì§€ë¡œ ì´ë™"><%= ê¸€ëª©ë¡[i].title %></a>
                        <span class="delete" data-id="<%= ê¸€ëª©ë¡[i]._id %>">
                            <ion-icon style="font-size: 20px;" name="trash-outline"
                            data-id="<%= ê¸€ëª©ë¡[i]._id %>"></ion-icon>
                        </span>
                        <p>ì‘ì„±ì: <%= ê¸€ëª©ë¡[i].ì‘ì„±ì %></p>
                        <div>
                            <button class="btn" data-id="<%= ê¸€ëª©ë¡[i].ì‘ì„±ì_id %>" aria-label="<%= ê¸€ëª©ë¡[i].ì‘ì„±ì %> ì™€ ì±„íŒ…"
                                data-name="<%= ê¸€ëª©ë¡[i].ì‘ì„±ì %>">
                                <a class="btn-a" href="/chat/matches?name=<%= ê¸€ëª©ë¡[i].ì‘ì„±ì %>&id=<%= ê¸€ëª©ë¡[i].ì‘ì„±ì_id %>">ì±„íŒ…í•˜ê¸°</a>
                            </button>
                        </div>
                    </h4>
                </div>
                
            <p style="clear: both; margin: 0px;"></p>
            </div>      
        <% }%>
        <div style="position: relative;">
            <div class="page-box">
                <p></p>
                <ion-icon style="font-size: 24px;" class="first" name="ellipsis-horizontal-outline"></ion-icon>
                <ion-icon class="back" name="caret-back-outline"></ion-icon>
                <%for (let i=((Math.ceil(í˜ì´ì§€ë„˜ë²„/5))*5)-4; i<((Math.ceil(í˜ì´ì§€ë„˜ë²„/5))*5)+1; i++){ %>
                    <% if(i>(Math.ceil(ê¸€ìˆ˜/5))){break} %>
                    <span style="margin: 3px;" class="page-btn" data-num="<%= i %>"><%= i %></span>
                <% }%>
                <ion-icon class="forward" name="caret-forward-outline"></ion-icon>
                <ion-icon style="font-size: 24px;" class="last" name="ellipsis-horizontal-outline"></ion-icon>
            </div>
            <div class="newPost">
                <a href="/write" aria-label="ê¸€ì“°ê¸° í˜ì´ì§€ë¡œ ì´ë™">ê¸€ì“°ê¸°âœï¸</a>
            </div>
        </div>
        <div class="ccontainer">
            <div class="search-bar">
                <input type="text" class="search_2" id="ssearch-input" placeholder=" ê¸€ì œëª©ìœ¼ë¡œ ê²€ìƒ‰">
                <button type="submit" id="ssearch" aria-label="ê²Œì‹œë¬¼ ê²€ìƒ‰">
                    <ion-icon name="search-outline"></ion-icon>
                </button>
            </div>
        </div>
        <div class="curtain" id="draggableElement">
            <div class="draggableChatbox">
                <div id="chatBox"></div>
            </div>
            <div class="input-group mb-3" style="width: 100%; ">
                <input type="text" id="input1" class="form-control" aria-describedby="ì±„íŒ… ë©”ì„¸ì§€ ì‘ì„±"  
                placeholder="ì—”í„°ì‹œì „ì†¡">
                <button type="button" id="button-addon2" aria-label="ì±„íŒ… ë©”ì„¸ì§€ ì „ì†¡">
                <ion-icon style="color: white; font-size: 18px;
                margin-top: 3px;" name="paper-plane-outline"></ion-icon>
                </button>
            </div>
        </div>
        <div style="clear: both;"></div>
    </div>
    <script src="/socketChat.js"></script>
    <script type="module">
        import {makeSnowflake2} from '/snow.js';
        window.onload = function(){
            for (let i = 0; i < 40; i++){
                setTimeout(makeSnowflake2(), 500 * i);
            }
        }      
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        $(document).ready(function() {
            const currentPage = parseInt('<%= í˜ì´ì§€ë„˜ë²„ %>');
            const totalPosts = parseInt('<%= ê¸€ìˆ˜ %>');

            // ê²Œì‹œê¸€ ì‚­ì œ
            for (let i=0; i<'<%= ê¸€ëª©ë¡.length %>'; i++){ 
                document.querySelectorAll('.delete')[i].addEventListener('click', async function(e){
                    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')==true){
                        try{
                            const response = await fetch('/list/?docid=' + e.target.dataset.id, {
                                method : 'DELETE',
                            })
                            if(response.ok){
                                alert('ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                location.reload();
                                return
                            } else if(response.status == 401){
                                alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')
                            } else if(response.status == 403){
                                alert('ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
                            } else if (response.status == 500){
                                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                            } else {
                                alert('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                            }
                        } catch(error){
                            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                        }
                    }
                })
            }
            
            // ê²Œì‹œê¸€ ê²€ìƒ‰
            function search(){
                var searchWord = $('#ssearch-input').val()
                if (!searchWord) {
                    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    return;
                }
                window.location.replace('/list/search?value='+encodeURIComponent(searchWord))
            }
            $('#ssearch').click(function(){
                search()
            })
            $('.search_2').keypress(function(e){
                if (e.keyCode===13){
                    search()
                }
            })

            // í˜ì´ì§€ ë²„íŠ¼ì— í˜„ì¬ í˜ì´ì§€ í‘œì‹œ
            document.getElementsByClassName('page-btn')[(currentPage-1)%5].classList.add('nowPage');
            
            // í´ë¦­í•œ ìˆ«ìì— í•´ë‹¹í•˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™
            $('.page-btn').click(function(e){
                $('.page-btn').removeClass('nowPage')
                const num = e.target.dataset.num;
                window.location.href=`/list/${num}?í˜ì´ì§€ë„˜ë²„=`+num;
            });

            // ì²« ë²ˆì§¸ í˜ì´ì§€ë¡œ ì´ë™
            $('.first').click(function(){
                window.location.href=`/list/1?í˜ì´ì§€ë„˜ë²„=1`;
            })
            // ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
            $('.last').click(function(){
                const lastPage = Math.ceil(totalPosts/5)
                window.location.href=`/list/${lastPage}?í˜ì´ì§€ë„˜ë²„=`+ lastPage;
            })  
            // -1 í˜ì´ì§€ë¡œ ì´ë™
            $('.back').click(function(){
                const prevPage = currentPage - 1;
                window.location.href=`/list/prev/<%= ê¸€ëª©ë¡[ê¸€ëª©ë¡.length-ê¸€ëª©ë¡.length]._id %>?pageNum=`+ prevPage;
            })
            // +1 í˜ì´ì§€ë¡œ ì´ë™
            $('.forward').click(function(){
                const nextPage = currentPage + 1;
                window.location.href=`/list/next/<%= ê¸€ëª©ë¡[ê¸€ëª©ë¡.length-1]._id %>?pageNum=`+ nextPage;
            })

            const socket = io();

            // ì›¹ì†Œì¼“ ì±„íŒ… ë°œì‹ 
            function sendMessage(){
                const message = $('#input1').val();
                if (message) { 
                    socket.emit('user-send', message);
                    $('#input1').val(''); 
                }
            }
            $('#button-addon2').click(sendMessage)
            $('.input-group').keypress(function(e){
                if (e.keyCode===13){
                    sendMessage()
                }
            })

            // ì›¹ì†Œì¼“ ì±„íŒ… ë°ì´í„°ë¥¼ ì±„íŒ…ë°•ìŠ¤ì— í‘œì‹œ
            socket.on('broadcast', function(data){        
                const chatMessage = `<div class="chatOne"> ğŸµ${data}<br/><div>`
                $('#chatBox').append(chatMessage);
                const chatBox = document.querySelector('.draggableChatbox').scrollHeight;
                $('.draggableChatbox').scrollTop(chatBox+100); 
            })

            // ë©”ì„¸ì§€ë¥¼ ì½ê³  ë’¤ë¡œê°€ê¸°ë¥¼ í–ˆì„ ë•Œ ë©”ì„¸ì§€ ì½ìŒ í‘œì‹œ
            window.addEventListener('pageshow', async (event) => {
                const what = {
                    content : "list",
                }
                const response = await fetch('/log/locations', {
                    method : 'PUT',
                    headers : { 'Content-Type' : 'application/json' },
                    body : JSON.stringify(what)
                })
                if(!response.ok){
                    return
                } else {
                    $('.navigation').load(location.href+' .navigation');
                }
            });
        })
        // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìµœì í™” api ìš”ì²­
        document.addEventListener('DOMContentLoaded', async function() {
            const urlArray = '<%= thumbailUrls %>'.split(',');
            try {
                const response = await fetch('/optimize/thumbnails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(urlArray)
                });
                if (response.ok) {
                    const responseData = await response.json();
                    const imgElements = document.querySelectorAll('.list-left');
                    responseData.forEach((src, index) => {
                        if (imgElements[index]) {
                            imgElements[index].src = src;
                        }
                    });
                    return
                } else if (response.status == 404){
                    console.log('ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
                } else if (response.status == 500) {
                    console.log('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                } else {
                    console.log('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')
            }
        });
    </script>
    

</body>


</html>