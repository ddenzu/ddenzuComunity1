<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
    <link rel="stylesheet" href="\main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body style="background-color: #131931;">
    <div class="wrap">
        <div class="nav">
            <h2 class="logo"><a style="text-decoration: none;" href="/list/1">ÌôàüéÑ</a></h2>
            <nav class="navigation">
                <a href="/mypage">MYPAGE</a>
                <% if (!isRead) { %>
                    <a id="chatAlert" href="/chat">CHATROOM</a>
                <% } else { %>
                    <a href="/chat">CHATROOM</a>
                <% } %>
                <a href="/login">LOGIN</a>
                <a href="/register">REGISTER</a>
            </nav>
        </div> 
    </div>
    <div class="section2">
        <div style="height:60px;"></div>
        <div class="detail-bg">
            <h4 style="font-size: x-large; padding: 5px; margin: 0px; border-top: 2px #494a51 solid;
            border-bottom: 2px #494a51 solid;"><%= Í∏ÄÎ™©Î°ù.title %>
            <p style="float: right; font-size: 14px;padding: 5px; padding-top: 13px; margin: 0px;
            font-weight: normal;color: #212529;"><%= Í∏ÄÎ™©Î°ù.date %></p>
            </h4>
            <p style="font-size: small; margin-top: 5px;">ÏûëÏÑ±Ïûê:
                <a class="btn-a" style="text-decoration: none; color: black;" 
                href="/chatroom?name=<%= Í∏ÄÎ™©Î°ù.ÏûëÏÑ±Ïûê %>&id=<%= Í∏ÄÎ™©Î°ù.ÏûëÏÑ±Ïûê_id %>">
                    <img style="cursor: pointer; width: 25px; height: 25px; vertical-align: bottom; margin-right: 2px;" 
                    src="https://ddenzubucket.s3.ap-northeast-2.amazonaws.com/<%= ÌîÑÎ°úÌïÑ %>" 
                    loading="lazy" onerror="this.src='/image/dinosaur.png'"/><%= Í∏ÄÎ™©Î°ù.ÏûëÏÑ±Ïûê %>
                </a> 
            </p>
            <% for (let i = 0; i < ÎèôÏòÅÏÉÅÏ£ºÏÜå.length; i++) { %>
                <div class="img-box">
                    <video src="https://ddenzubucket.s3.ap-northeast-2.amazonaws.com/<%= ÎèôÏòÅÏÉÅÏ£ºÏÜå[i] %>" type="video/mp4" controls muted loop autoplay 
                    playsinline preload="metadata" style="width: 200px" loading="lazy" onerror="this.style.display='none';">
                    </video>
                </div>
            <% } %>
            <% for (let i = 0; i < Ïù¥ÎØ∏ÏßÄÏ£ºÏÜå.length; i++) { %>
                <div class="img-box">
                    <img style="max-width: 330px;" loading="lazy" 
                    src="https://ddenzubucket.s3.ap-northeast-2.amazonaws.com/<%= Ïù¥ÎØ∏ÏßÄÏ£ºÏÜå[i] %>"/>
                </div>
            <% } %>
            <p>
                <% 
                // Í∏ÄÎ™©Î°ù.contentÏóê ÏûàÎäî ÌÖçÏä§Ìä∏ÏóêÏÑú Ï£ºÏÜåÎ•º Ï∞æÏïÑ ÎßÅÌÅ¨Î°ú Î≥ÄÌôòÌï©ÎãàÎã§.
                // Ï†ïÍ∑ú ÌëúÌòÑÏãùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ http:// ÎòêÎäî https://Î°ú ÏãúÏûëÌïòÎäî Ï£ºÏÜåÎ•º Ï∞æÏäµÎãàÎã§.
                var contentWithLinks = Í∏ÄÎ™©Î°ù.content.replace(
                    /((http|https):\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank">$1</a>'
                ).replace(/\n/g, '<br/>');
                %>
                <%- contentWithLinks %> 
            </p>
            <div class="like-box">
                <div id="likee" style="display: flex; align-items: center;">
                    <span name="like" class="like" data-postId="<%= Í∏ÄÎ™©Î°ù._id %>" id="likeButton">
                        <i class="fa-solid fa-thumbs-up like-icon"></i>
                    </span>
                    <span id="like-cnt" >
                        <p class="like" style="margin: 0px;"><%= Í∏ÄÎ™©Î°ù.like %></p>
                    </span>
                </div>
            </div>
        </div> 

        <div class="comment">
                <div class="ccontainer">
                    <div class="comment-bar">
                        <div class="comment-write" style="width:97%;">
                            <textarea style="width: 80%; float: left; padding-top: 2px;" class="comment_2" id="comment-input" placeholder=" ÏóîÌÑ∞ÎàÑÎ•¥Î©¥ Ï§ÑÎ∞îÍøà"></textarea>
                            <button style="float: right;" id="comment-btn"><ion-icon name="paper-plane-outline"></ion-icon></button>
                        </div>
                    </div>
                </div>
            <div id="comment-box" style="margin: 0; display: block;">
                <%for (let i=0; i<ÎåìÍ∏ÄÎ™©Î°ù.length; i++){ %>
                    <p style="text-align: left; margin-bottom: 20px; clear: both;">
                        <div class="profile">
                            <div class="profileImage" data-name="<%= ÎåìÍ∏ÄÎ™©Î°ù[i].username %>" data-id="<%= ÎåìÍ∏ÄÎ™©Î°ù[i].userId %>">
                                <button style="background: transparent; border: none;">
                                    <a class="btn-a" href="/chatroom?name=<%= ÎåìÍ∏ÄÎ™©Î°ù[i].username %>&id=<%= ÎåìÍ∏ÄÎ™©Î°ù[i].userId %>">
                                        <img style="cursor: pointer; width: 25px;height: 25px;object-fit: cover;
                                        padding-left: 5px;" loading="lazy" 
                                        src="https:/ddenzubucket.s3.ap-northeast-2.amazonaws.com/<%= ÎåìÍ∏ÄÎ™©Î°ù[i].userprofile %>"
                                        onerror="this.src='/image/dinosaur.png'" />
                                    </a>
                                </button>
                            </div>
                            <div class="profile2">
                                <div class="profiletext"><%= ÎåìÍ∏ÄÎ™©Î°ù[i].username %></div>
                            </div>
                        </div>
                        <div id="profile3" class="profile3"><%- ÎåìÍ∏ÄÎ™©Î°ù[i].content.replace(/\n/g, '<br/>') %>
                            <p style="clear: both"></p>
                            <p class="commentTime">
                                <% var time = dateFormat1.dateFormat(new Date(ÎåìÍ∏ÄÎ™©Î°ù[i].date)) %>
                                <%= time %>
                                <div class="reComment" data-num="<%= i %>">ÎãµÍ∏Ä</div>
                                <div class="reComment_cancel changeNameVisible" data-num="<%= i %>">Ï∑®ÏÜå</div>
                            </p>  
                            <div class="reComment_box changeNameVisible">
                                <textarea class="reComment_input" id="reComment-input" placeholder="ÏóîÌÑ∞ÎàÑÎ•¥Î©¥ Ï§ÑÎ∞îÍøà"></textarea>
                                <ion-icon class="reComment_send" name="paper-plane-outline"
                                data-id="<%= ÎåìÍ∏ÄÎ™©Î°ù[i]._id %>" data-num="<%= i %>"></ion-icon>
                            </div>
                            <div style="clear: both"></div>
                            <%for (let j=0; j<ÎåÄÎåìÍ∏Ä.length; j++){ %>
                                <% a= JSON.stringify(ÎåÄÎåìÍ∏Ä[j].parentId) %>
                                <% b= JSON.stringify(ÎåìÍ∏ÄÎ™©Î°ù[i]._id) %>
                                <%if(a==b){%>
                                    <div class="reComment-box">
                                        <div style="display: flex; flex-direction: column;">
                                            <a class="btn-a" href="/chatroom?name=<%= ÎåÄÎåìÍ∏Ä[j].username %>&id=<%= ÎåÄÎåìÍ∏Ä[j].userId %>">
                                                <img style="cursor: pointer; width: 25px;height: 25px;object-fit: cover;
                                                padding-left: 8px;" loading="lazy" 
                                                src="https:/ddenzubucket.s3.ap-northeast-2.amazonaws.com/<%= ÎåÄÎåìÍ∏Ä[j].userprofile %>"
                                                onerror="this.src='/image/dinosaur.png'" />
                                            </a>
                                            <div style="width: 42px; text-align: center; margin-top: 0px;" class="profiletext"><%= ÎåÄÎåìÍ∏Ä[j].username %></div>
                                        </div>

                                        <div style="display: flex; flex-direction: column;">
                                            <p style="font-size: 16px; margin: 3px 0px 0px 4px; display: block;"><%= ÎåÄÎåìÍ∏Ä[j].content %></p>
                                            <% var time1 = dateFormat1.dateFormat(new Date(ÎåÄÎåìÍ∏Ä[j].date)) %>
                                            <p class="commentTime" style="margin: 3px 0px 0px 4px;"><%= time1 %></p>
                                        </div>
                                        <span style="margin: 7px 0px 0px 7px;" name="add" id="commentDel" data-id="<%= ÎåÄÎåìÍ∏Ä[j]._id %>"
                                            data-postId="<%= ÎåÄÎåìÍ∏Ä[j].postId %>" data-userId="<%= ÎåÄÎåìÍ∏Ä[j].userId %>">
                                            <ion-icon style="font-size: 20px; color: #5a545c;" name="trash-outline"></ion-icon>
                                        </span>
                                    </div>
                                <%} %>
                            <%}%>
                        </div>
                        <span name="add" id="commentDel" data-id="<%= ÎåìÍ∏ÄÎ™©Î°ù[i]._id %>"
                            data-postId="<%= ÎåìÍ∏ÄÎ™©Î°ù[i].postId %>" data-userId="<%= ÎåìÍ∏ÄÎ™©Î°ù[i].userId %>">
                            <ion-icon style="font-size: 20px; color: #5a545c;" name="trash-outline"></ion-icon>
                        </span>
                    </p>
                    <div style="clear: both; height: 0px;"></div>
                    <p class="comment-line"></p>
                <% }%>
                
            </div>
        </div>
        <div class="infomation" style="background-color:rgba(0, 0, 0, 0.2);">
        </div>
    </div>
    <script type="module">
        import {makeSnowflake2} from '/snow.js';
        window.onload = function(){
            for (let i = 0; i < 40; i++){
                setTimeout(makeSnowflake2(), 500 * i);
            }
        }       
      </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        var ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏Äid = '<%= Í∏ÄÎ™©Î°ù._id %>'
        var ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏ÄÏù¥Î¶Ñ = '<%= Í∏ÄÎ™©Î°ù.title %>'
        var ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏Ä = '<%- Í∏ÄÎ™©Î°ù.content.replace(/(?:\r\n|\r|\n)/g, '<br>') %>'
        var ÏßÄÏö∏Í±∞ 
        $(document).on("click","span[name='like']", function(e){
            var Î≥¥ÎÇºÍ±∞ = {postid : ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏Äid,
            }
            $.post('/add-like', Î≥¥ÎÇºÍ±∞).then(()=> {
                reloadLike();
          })
        })
        var box = $(".profile2");
        $('.profile2').change(function(){
        })

        document.querySelector('#comment-btn').addEventListener('click', ()=>{
            var ÎåìÍ∏ÄÎÇ¥Ïö© = $('#comment-input').val()
            var Î≥¥ÎÇºÍ±∞ = {
                parent : ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏Äid,
                content : ÎåìÍ∏ÄÎÇ¥Ïö©,
            }
            fetch('/comment', {
            method : 'POST',
            async : false,
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify(Î≥¥ÎÇºÍ±∞)
            })
            .then((r)=>r.text())
            .then((r)=>{
                if(r=="ÎåìÍ∏ÄÏ†ÄÏû•"){
                    $('#comment-box').load(location.href+' #comment-box');
                    $('.comment_2').val('');
                } else {
                    alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî')
                }
            }) 
        })

        $(document).on("click",".reComment_send", function(e){
            var ÎåìÍ∏ÄÎÇ¥Ïö© = document.querySelectorAll('#reComment-input')[e.target.dataset.num].value;
            document.querySelectorAll('#reComment-input')[e.target.dataset.num].value = '';
            var Î≥¥ÎÇºÍ±∞ = {
                parent : ÏßÄÍ∏àÎàÑÎ•∏ÏûëÏÑ±Í∏Äid,
                reparent : e.target.dataset.id,
                content : ÎåìÍ∏ÄÎÇ¥Ïö©,
            }
            fetch('/recomment', {
            method : 'POST',
            async : false,
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify(Î≥¥ÎÇºÍ±∞)
            })
            .then((r)=>r.text())
            .then((r)=>{
                if(r=="ÎåÄÎåìÍ∏ÄÏ†ÄÏû•"){
                    $('#comment-box').load(location.href+' #comment-box');
                } else {
                    alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî')
                }
            }) 
        })

        $(document).on("click","span[name='add']", function(e){
            if (confirm('Î¶¨ÏñºÎ£®Îã§Í∞Ä ÏÇ≠Ï†úÌïòÏãúÍ≤†Ïä¥ÍπåÎÇòÎ¶¨?')==true){
                var ÏßÄÏö∏Í±∞ = {id : this.dataset.id,
                userId : this.dataset.userid}
                fetch('/delete-comment', {
                method : 'POST',
                async : false,
                headers : {
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify(ÏßÄÏö∏Í±∞)
                })
                .then((r)=>r.text())
                .then((r)=>{
                    if(r=='ÏÑúÎ≤ÑÏóêÎü¨' || r=='fail'){
                        alert('ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§')
                    }
                    else {
                        $('#comment-box').load(location.href+' #comment-box');
                    }
                }) 
            }
            else {
                return 0
            }
        }) 
        $(document).ready(function() {
            const profileElement = $('.profile2');
            if (profileElement.html() && profileElement.html().length > 2) {
                profileElement.text().substr(0, 3);
            }
        });

        document.querySelector('.comment-bar').addEventListener('click', () => {
            if ('<%= ÌòÑÏû¨Ï†ëÏÜçÏûê %>' == "noUser") {
                if (confirm('ÎåìÍ∏Ä ÏûëÏÑ±ÏùÑ ÏúÑÌï¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπåÌÉàÎ†àÎÇò') == true) {
                    window.location.replace(`/login`);
                }
            }
        });
        const reCommentBox = document.querySelector('.reComment_box');
        if (reCommentBox) {
            reCommentBox.addEventListener('click', () => {
                if ('<%= ÌòÑÏû¨Ï†ëÏÜçÏûê %>' == "noUser") {
                    if (confirm('ÎåìÍ∏Ä ÏûëÏÑ±ÏùÑ ÏúÑÌï¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπåÌÉàÎ†àÎÇò') == true) {
                        window.location.replace(`/login`);
                    }
                }
            });
        }
      
        function reloadLike(){
            $('#like-cnt').load(location.href+' #like-cnt');
        }

        $(document).on("click",'.reComment', function(e){
            if('<%= ÌòÑÏû¨Ï†ëÏÜçÏûê %>'=="noUser"){
                if (confirm('ÎåìÍ∏ÄÏûëÏÑ±ÏùÑ ÏúÑÌï¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπåÌÉàÎ†àÎÇò')==true){
                    return window.location.replace(`/login`) 
                }
            } else {
                document.querySelectorAll('.reComment_box')[this.dataset.num].classList.remove('changeNameVisible');
                document.querySelectorAll('.reComment')[this.dataset.num].classList.add('reComment_click');
                document.querySelectorAll('.reComment_cancel')[this.dataset.num].classList.remove('changeNameVisible');
            }
        })        
        $(document).on("click",'.reComment_cancel', function(e){
            document.querySelectorAll('.reComment_box')[this.dataset.num].classList.add('changeNameVisible');
            document.querySelectorAll('.reComment')[this.dataset.num].classList.remove('reComment_click');
            document.querySelectorAll('.reComment_cancel')[this.dataset.num].classList.add('changeNameVisible');
        })

        const likeButton = document.getElementById('likeButton');
        likeButton.addEventListener('click', function() {
            var icon = this.querySelector('.like-icon');
            icon.style.color = '#FE4D4D';
            icon.style.transform = 'scale(1.2)';
            setTimeout(function() {
                icon.style.color = 'white';
                icon.style.transform = 'scale(1)';
            }, 500);
        });
        window.addEventListener('pageshow', (event) => {
            let what = {
                content : "detail",
            }
            fetch('/location-update', {
            method : 'POST',
            async : false,
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify(what)
            })
            .then((r)=>r.text())
            .then((r)=>{
                $('.navigation').load(location.href+' .navigation');
            })
        });
    </script>

</body>
</html>